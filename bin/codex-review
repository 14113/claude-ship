#!/bin/bash
# Codex Code Review - reviews all changes on current branch
# Usage: bin/codex-review OUTPUT_PATH

set -e

OUTPUT_PATH="${1:?Usage: bin/codex-review OUTPUT_PATH}"

# Detect base branch from PR or default to master
BASE_BRANCH=$(gh pr view --json baseRefName -q '.baseRefName' 2>/dev/null || echo "master")

echo "Reviewing changes against: $BASE_BRANCH"

# Get full branch diff
DIFF=$(git diff "$BASE_BRANCH"...HEAD; git diff; git diff --cached)

if [ -z "$DIFF" ]; then
  echo "No changes found against $BASE_BRANCH"
  echo "## Codex Review: PASS (no changes)" > "$OUTPUT_PATH"
  exit 0
fi

# Build prompt with review instructions + diff
PROMPT_FILE=$(mktemp)
cat > "$PROMPT_FILE" <<'INSTRUCTIONS'
You are a senior Rails developer performing a thorough code review.
DO NOT make any changes to the code. Only analyze and report findings.

## Review Focus Areas

### 1. Security (CRITICAL)
- SQL injection, XSS, CSRF vulnerabilities
- Mass assignment protection (strong parameters)
- Authentication/authorization gaps
- Sensitive data exposure (logs, responses)
- Multi-tenant data isolation (Current.account scoping)

### 2. Performance
- N+1 query problems (missing includes/preload)
- Unnecessary database calls in loops
- Missing database indexes for queried columns
- Large data set handling without pagination

### 3. Code Quality
- Single Responsibility Principle violations
- Dead code or unused variables
- Overly complex methods (should be extracted)
- Missing error handling for external calls

### 4. Rails Best Practices
- Fat controllers (logic belongs in services/models)
- Business logic in views (should use presenters)
- Proper use of ActiveRecord callbacks
- Transaction safety for multi-step operations

### 5. Testing
- Missing test coverage for new code paths
- Edge cases not covered
- Test isolation issues

## Output Format

```
## Codex Review: [PASS/FAIL]

### Critical Issues
| Location | Category | Issue | Fix |
|----------|----------|-------|-----|

### High Issues
| Location | Category | Issue | Fix |
|----------|----------|-------|-----|

### Summary
[1 sentence assessment]

### Merge Readiness: [X]%
```

If no issues: `## Codex Review: PASS` with brief note what was checked.

## Merge Readiness Scale

End every review with: `### Merge Readiness: X%`

- **100%** - ONLY if you checked EVERY line and found ZERO concerns
- **90-99%** - Code looks good, minor uncertainty
- **80-89%** - Minor concerns exist but acceptable
- **50-79%** - Real issues found, fix before merge
- **0-49%** - Critical issues, BLOCK merge

## Diff to Review

INSTRUCTIONS

echo '```diff' >> "$PROMPT_FILE"
echo "$DIFF" >> "$PROMPT_FILE"
echo '```' >> "$PROMPT_FILE"

# Pass prompt via stdin. Extract review text after "codex" marker (strips CLI preamble).
codex review - < "$PROMPT_FILE" 2>&1 | sed -n '/^codex$/,$ { /^codex$/d; p; }' > "$OUTPUT_PATH"
rm -f "$PROMPT_FILE"

echo "CODEX_REVIEW: DONE | Output: $OUTPUT_PATH"
