#!/bin/bash
# Codex Code Review - reviews all changes on current branch
# Usage: bin/codex-review OUTPUT_PATH

set -e

OUTPUT_PATH="${1:?Usage: bin/codex-review OUTPUT_PATH}"

# Detect base branch from PR or default to master
BASE_BRANCH=$(gh pr view --json baseRefName -q '.baseRefName' 2>/dev/null || echo "master")

echo "Reviewing changes against: $BASE_BRANCH"

# Get full branch diff
DIFF=$(git diff "$BASE_BRANCH"...HEAD; git diff; git diff --cached)

if [ -z "$DIFF" ]; then
  echo "No changes found against $BASE_BRANCH"
  echo "## Codex Review: PASS (no changes)" > "$OUTPUT_PATH"
  exit 0
fi

# Build prompt with review instructions + diff
PROMPT_FILE=$(mktemp)
cat > "$PROMPT_FILE" <<'INSTRUCTIONS'
You are a senior Rails developer performing a code review. Read-only analysis — no code changes.

## Priorities (in order)

1. **Security first** — SQL injection, XSS, CSRF, mass assignment, auth gaps, tenant isolation (Current.account)
2. **Correctness** — data integrity, transaction safety, error handling for external calls
3. **Performance** — N+1 queries, missing indexes, unbounded queries, sync operations in request cycle
4. **Maintainability** — SRP violations, fat controllers, logic in views, dead code, missing tests

## Output Format

```
## Codex Review: [PASS/FAIL]

### Critical Issues
| Location | Category | Issue | Fix |
|----------|----------|-------|-----|

### High Issues
| Location | Category | Issue | Fix |
|----------|----------|-------|-----|

### Summary
[1 sentence assessment]

### Merge Readiness: [X]%
```

If no issues: `## Codex Review: PASS` with brief note what was checked.

## Merge Readiness Scale

End every review with: `### Merge Readiness: X%`

- **100%** - ONLY if you checked EVERY line and found ZERO concerns
- **90-99%** - Code looks good, minor uncertainty
- **80-89%** - Minor concerns exist but acceptable
- **50-79%** - Real issues found, fix before merge
- **0-49%** - Critical issues, BLOCK merge

## Diff to Review

INSTRUCTIONS

echo '```diff' >> "$PROMPT_FILE"
echo "$DIFF" >> "$PROMPT_FILE"
echo '```' >> "$PROMPT_FILE"

# Pass prompt via stdin. Extract review text after "codex" marker (strips CLI preamble).
codex review - < "$PROMPT_FILE" 2>&1 | sed -n '/^codex$/,$ { /^codex$/d; p; }' > "$OUTPUT_PATH"
rm -f "$PROMPT_FILE"

echo "CODEX_REVIEW: DONE | Output: $OUTPUT_PATH"
